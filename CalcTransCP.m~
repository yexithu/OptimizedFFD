function [rotCell] = CalcTransCP(curCP, dstCP, scale)
    if (nargin<3)
        scale = 1;
    end

    %%first divide control points
%     stride = 1;
    l = 8;
    m = 8;
    n = 8;
    
    rotCell = cell(l+1,m+1,n+1);
    
    % for a single cell
    for i = 1:(l+1)

        if i == 1
            startI = i;
            centerI = 1;
        else
            startI = i-1;
            centerI = 2;
        end
        if i == l+1
            endI = i;
        else
            endI = i+1;
        end
        
        lengthI = 3;
        if i == 1 || i == l+1
            lengthI = 2;
        end
        
        for j = 1:(m+1)
            if j == 1
                startJ = j;
                centerJ = 1;
            else
                startJ = j-1;
                centerJ = 2;
            end
            
            if j == m+1
                endJ = j;
            else
                endJ = j+1;
            end
            
            lengthJ = 3;
            if j == 1 || j == m+1;
                lengthJ = 2;
            end
            
            for k = 1:(n+1)
                
                curCube = curCP(startI:endI,startJ:endJ,startK:endK);
                dstCube = dstCP(startI:endI,startJ:endJ,startK:endK);
                
                curCenter = curCube(centerI,centerJ,centerK);
                dstCenter = dstCube(centerI,centerJ,centerK);
                
                groupSize = lengthI * lengthJ * lengthK;

                curEdgeWithCenter = curCenter - reshape(cell2mat(curCube), 3, groupSize);
                dstEdgeWithCenter = dstCenter - reshape(cell2mat(dstCube), 3, groupSize);

                curEdge = curEdgeWithCenter;
                curEdge(:, (groupSize + 1)/2) = [];
                dstEdge = dstEdgeWithCenter;
                dstEdge(:, (groupSize + 1)/2) = [];


                [idx, dist] = knnsearch(curEdge', dstEdge');
                cEdge = dstEdge(:,idx);
                [~, ~, pCEdge, qCEdge] = Centralization(curEdge, cEdge);
                [~, N] = CalcSumProd(pCEdge, qCEdge);

                [~, r, ~] = CalcQuat(N);
                rotation = scale * r;
                
                %collect rotation
                rotCell(i,j,k) = {rotation};
                   
                err = sum(dist) / length(dist);
                fprintf('err: %f\n', err);
            end
        end
    end
    
end

function [start, end, center, length] = getNbrArg(x)
    if k == 1
        startK = 1;
        centerK = 1;
    else
        startK = k-1;
        centerK = 2;
    end

    if k == n+1
        endK = k;
    else
        endK = k+1;
    end

    lengthK = 3;
    if k == 1 || k == n+1
        lengthK = 2;
    end
end